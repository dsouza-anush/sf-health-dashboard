{% extends "base.html" %}

{% block title %}Dashboard - Salesforce Health Check{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h1 class="mb-0">Health Check Dashboard</h1>
            <div class="d-flex align-items-center">
                <div class="chart-time-range me-3">
                    <select id="time-range-selector" class="form-select form-select-sm">
                        <option value="day">Last 24 Hours</option>
                        <option value="week" selected>Last 7 Days</option>
                        <option value="month">Last 30 Days</option>
                        <option value="quarter">Last 90 Days</option>
                    </select>
                </div>
                <button class="btn btn-primary btn-sm" id="refresh-data">
                    <i class="bi bi-arrow-repeat me-1"></i> Refresh Data
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-label">Total Alerts</div>
            <div class="stat-value">{{ stats.total_alerts }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-label">Unresolved</div>
            <div class="stat-value">{{ stats.unresolved_alerts }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-label">Critical</div>
            <div class="stat-value status-critical">{{ stats.by_priority.critical }}</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-label">Categories</div>
            <div class="stat-value">{{ stats.by_ai_category | length }}</div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-pie-chart me-2"></i>
                    Alerts by Priority
                </div>
                <div class="chart-controls">
                    <button class="btn btn-sm btn-icon" id="priority-chart-toggle" title="Change chart type">
                        <i class="bi bi-bar-chart"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="priority-chart" style="height: 320px;"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-bar-chart me-2"></i>
                    Alerts by Source Category
                </div>
                <div class="chart-controls">
                    <button class="btn btn-sm btn-icon historical-toggle" id="category-chart-history-toggle" title="Show historical data">
                        <i class="bi bi-clock-history"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="category-chart" style="height: 320px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="bi bi-funnel me-2"></i>
                    <span>Filter Alerts</span>
                </div>
                <button id="categorize-all-btn" class="btn btn-sm btn-primary">
                    <i class="bi bi-magic me-1"></i> Categorize All
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <label for="filter-by-category" class="form-label text-sm">Category</label>
                        <select id="filter-by-category" class="form-select">
                            <option value="">All Categories</option>
                            <option value="configuration">Configuration</option>
                            <option value="security">Security</option>
                            <option value="performance">Performance</option>
                            <option value="data">Data</option>
                            <option value="integration">Integration</option>
                            <option value="compliance">Compliance</option>
                            <option value="code">Code</option>
                            <option value="user experience">User Experience</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-2">
                        <label for="filter-by-priority" class="form-label text-sm">Priority</label>
                        <select id="filter-by-priority" class="form-select">
                            <option value="">All Priorities</option>
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-2">
                        <label for="filter-by-status" class="form-label text-sm">Status</label>
                        <select id="filter-by-status" class="form-select">
                            <option value="">All Statuses</option>
                            <option value="open">Open</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card insight-container">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="bi bi-stars me-2"></i>
                    <span>AI Insights</span>
                </div>
                <div class="insight-badge">
                    <span class="ai-badge">3</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="insight-preview d-flex align-items-center justify-content-between px-4 py-3">
                    <div class="d-flex align-items-center gap-3">
                        <div class="insight-indicator primary"></div>
                        <div>
                            <h6 class="mb-0 text-sm">Alert Pattern Detected</h6>
                            <p class="text-xs mb-0 text-muted">Portal errors increased by 25%</p>
                        </div>
                    </div>
                    <button class="btn-icon expand-insight" data-insight="insight-1" aria-label="Expand insight">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </div>
                <div id="insight-1" class="insight-detail" style="display: none;">
                    <div class="p-4 pt-0">
                        <p class="mb-3">Increase in Portal errors (25% this week) may be related to recent deployment.</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="ai-badge">AI Insight</span>
                            <button class="btn btn-sm btn-outline">View Analysis</button>
                        </div>
                    </div>
                </div>
                
                <div class="insight-preview d-flex align-items-center justify-content-between px-4 py-3 border-top">
                    <div class="d-flex align-items-center gap-3">
                        <div class="insight-indicator warning"></div>
                        <div>
                            <h6 class="mb-0 text-sm">Potential Issue</h6>
                            <p class="text-xs mb-0 text-muted">Unusual SOQL limit exceptions</p>
                        </div>
                    </div>
                    <button class="btn-icon expand-insight" data-insight="insight-2" aria-label="Expand insight">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </div>
                <div id="insight-2" class="insight-detail" style="display: none;">
                    <div class="p-4 pt-0">
                        <p class="mb-3">Unusual increase in SOQL limit exceptions detected in last 24 hours.</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="ai-badge">AI Insight</span>
                            <button class="btn btn-sm btn-outline">Investigate</button>
                        </div>
                    </div>
                </div>
                
                <div class="insight-preview d-flex align-items-center justify-content-between px-4 py-3 border-top">
                    <div class="d-flex align-items-center gap-3">
                        <div class="insight-indicator critical"></div>
                        <div>
                            <h6 class="mb-0 text-sm">Suggested Action</h6>
                            <p class="text-xs mb-0 text-muted">Add cache layer to Customer Portal API</p>
                        </div>
                    </div>
                    <button class="btn-icon expand-insight" data-insight="insight-3" aria-label="Expand insight">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </div>
                <div id="insight-3" class="insight-detail" style="display: none;">
                    <div class="p-4 pt-0">
                        <p class="mb-3">Consider adding cache layer to Customer Portal API to reduce load times.</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="ai-badge">AI Recommendation</span>
                            <button class="btn btn-sm btn-outline">Create Task</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="bi bi-bell me-2"></i>
                    <span>Recent Alerts</span>
                </div>
                <a href="/alerts" class="btn btn-sm btn-primary">
                    <i class="bi bi-arrow-right me-1"></i> View All
                </a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Source</th>
                                <th>AI Category</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alert in alerts %}
                            <tr>
                                <td><span class="badge bg-secondary">{{ alert.id }}</span></td>
                                <td>{{ alert.title }}</td>
                                <td>{{ alert.source_system }}</td>
                                <td>
                                    {% if alert.ai_category %}
                                    <span class="category-badge">{{ alert.ai_category }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Uncategorized</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if alert.ai_priority == "critical" %}
                                    <span class="badge priority-critical">Critical</span>
                                    {% elif alert.ai_priority == "high" %}
                                    <span class="badge priority-high">High</span>
                                    {% elif alert.ai_priority == "medium" %}
                                    <span class="badge priority-medium">Medium</span>
                                    {% elif alert.ai_priority == "low" %}
                                    <span class="badge priority-low">Low</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Pending</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if alert.is_resolved %}
                                    <span class="status-badge status-resolved">Resolved</span>
                                    {% else %}
                                    <span class="status-badge status-open">Open</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="/alert/{{ alert.id }}" class="action-btn" title="View alert details">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card health-summary-container">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="bi bi-lightning me-2"></i>
                    <span>AI Health Summary</span>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-xs text-muted">Last updated: {{ stats.last_updated }}</span>
                    <button class="btn-icon" id="toggle-health-summary" aria-label="Toggle health summary">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- Summary Preview - Always visible -->
                <div class="health-summary-preview px-4 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-2">
                            <div class="ai-badge">AI</div>
                            <p class="mb-0">System health: <strong>moderate stability</strong> with <span class="text-warning">30 unresolved</span> alerts</p>
                        </div>
                        <div class="health-indicators d-flex align-items-center">
                            <div class="health-indicator" title="Critical Issues">
                                <i class="bi bi-exclamation-triangle text-danger"></i> 6
                            </div>
                            <div class="health-indicator" title="Trends">
                                <i class="bi bi-graph-up text-warning"></i> 25%
                            </div>
                            <div class="health-indicator" title="Actions">
                                <i class="bi bi-check-circle text-success"></i> 2
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Health Summary - Expandable -->
                <div id="health-summary-detail" style="display: none;" class="border-top">
                    <div class="px-4 py-3">
                        <p class="mb-3">The primary concerns are high portal page load times and SOQL limit exceptions, which represent 36.4% of all alerts.</p>
                        
                        <div class="health-details">
                            <div class="health-detail-section">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                                    <h6 class="mb-0">Critical Issues</h6>
                                </div>
                                <p class="text-sm">6 critical alerts require immediate attention, focused on <strong>Partner Portal performance</strong> and <strong>SOQL limit exceptions</strong>.</p>
                            </div>
                            
                            <div class="health-detail-section">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-graph-up text-warning me-2"></i>
                                    <h6 class="mb-0">Notable Trends</h6>
                                </div>
                                <p class="text-sm">Observed 25% increase in portal alerts over the last 7 days, potentially related to recent deployment on 2025-08-10.</p>
                            </div>
                            
                            <div class="health-detail-section">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-check-circle text-success me-2"></i>
                                    <h6 class="mb-0">Recommended Actions</h6>
                                </div>
                                <p class="text-sm">Optimize Portal query performance and review SOQL queries in batch process components.</p>
                            </div>
                        </div>
                        
                        <button class="btn btn-sm btn-outline mt-2">
                            <i class="bi bi-file-text me-1"></i> Generate Full Health Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Chart type toggle and time range controls
        const priorityChartToggle = document.getElementById('priority-chart-toggle');
        const categoryHistoryToggle = document.getElementById('category-chart-history-toggle');
        const timeRangeSelector = document.getElementById('time-range-selector');
        const refreshDataBtn = document.getElementById('refresh-data');
        
        // Track chart states
        let priorityChartType = 'pie';
        let showCategoryHistory = false;
        let selectedTimeRange = 'week';
        // Filter functionality for the alerts table
        const categoryFilter = document.getElementById('filter-by-category');
        const priorityFilter = document.getElementById('filter-by-priority');
        const statusFilter = document.getElementById('filter-by-status');
        const categorizeAllBtn = document.getElementById('categorize-all-btn');
        
        function applyFilters() {
            const categoryValue = categoryFilter.value.toLowerCase();
            const priorityValue = priorityFilter.value.toLowerCase();
            const statusValue = statusFilter.value.toLowerCase();
            
            const rows = document.querySelectorAll('tbody tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                let showRow = true;
                
                // Check category filter
                if (categoryValue && categoryValue !== '') {
                    const cellCategory = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
                    if (!cellCategory.includes(categoryValue)) {
                        showRow = false;
                    }
                }
                
                // Check priority filter
                if (priorityValue && priorityValue !== '') {
                    const cellPriority = row.querySelector('td:nth-child(5)').textContent.toLowerCase();
                    if (!cellPriority.includes(priorityValue)) {
                        showRow = false;
                    }
                }
                
                // Check status filter
                if (statusValue && statusValue !== '') {
                    const cellStatus = row.querySelector('td:nth-child(6)').textContent.toLowerCase();
                    if (!cellStatus.includes(statusValue)) {
                        showRow = false;
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
                if (showRow) visibleCount++;
            });
            
            // Show filter summary
            updateFilterSummary(visibleCount, categoryValue, priorityValue, statusValue);
        }
        
        function updateFilterSummary(count, category, priority, status) {
            const tableContainer = document.querySelector('.table-responsive');
            let summaryDiv = document.getElementById('filter-summary');
            
            if (!summaryDiv) {
                summaryDiv = document.createElement('div');
                summaryDiv.id = 'filter-summary';
                summaryDiv.className = 'alert alert-info mt-2';
                tableContainer.insertAdjacentElement('afterbegin', summaryDiv);
            }
            
            if (category || priority || status) {
                const filters = [];
                if (category) filters.push(`Category: ${category}`);
                if (priority) filters.push(`Priority: ${priority}`);
                if (status) filters.push(`Status: ${status}`);
                
                summaryDiv.innerHTML = `
                    Showing ${count} filtered results (${filters.join(', ')})
                    <button id="clear-filters" class="btn btn-sm btn-outline-secondary ms-2">Clear Filters</button>
                `;
                summaryDiv.style.display = 'block';
                
                document.getElementById('clear-filters').addEventListener('click', clearFilters);
            } else {
                summaryDiv.style.display = 'none';
            }
        }
        
        function clearFilters() {
            categoryFilter.value = '';
            priorityFilter.value = '';
            statusFilter.value = '';
            applyFilters();
        }
        
        // Apply filters when any filter dropdown changes
        categoryFilter.addEventListener('change', applyFilters);
        priorityFilter.addEventListener('change', applyFilters);
        statusFilter.addEventListener('change', applyFilters);
        
        // Handle categorize all button
        if (categorizeAllBtn) {
            categorizeAllBtn.addEventListener('click', function() {
                // Show loading indicator
                const originalHTML = categorizeAllBtn.innerHTML;
                categorizeAllBtn.disabled = true;
                categorizeAllBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
                
                // Show toast notification
                const loadingToast = showToast('Categorizing all alerts with AI...', 'info');
                
                // Redirect with slight delay to show loading state
                setTimeout(() => {
                    window.location.href = '/categorize-all';
                }, 500);
            });
        }
        
        // Dark mode template for Plotly
        const darkLayout = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: {
                color: '#e0e0e0',
                family: 'Inter, -apple-system, BlinkMacSystemFont, system-ui, sans-serif',
                size: 12
            },
            margin: { t: 10, b: 60, l: 60, r: 30 },
            modebar: {
                bgcolor: 'rgba(0,0,0,0)',
                color: '#aaa',
                activecolor: '#007aff'
            },
            hoverlabel: {
                font: {
                    family: 'Inter, -apple-system, BlinkMacSystemFont, system-ui, sans-serif',
                    size: 12
                },
                bordercolor: '#333'
            }
        };
        
        // Priority chart data
        const priorityValues = [
            {{ stats.by_priority.critical }}, 
            {{ stats.by_priority.high }}, 
            {{ stats.by_priority.medium }}, 
            {{ stats.by_priority.low }},
            {{ stats.by_priority.uncategorized }}
        ];

        // Calculate percentages for better display
        const priorityTotal = priorityValues.reduce((a, b) => a + b, 0);
        const priorityPercentages = priorityValues.map(val => ((val / priorityTotal) * 100).toFixed(1) + '%');

        const priorityData = {
            values: priorityValues,
            labels: ['Critical', 'High', 'Medium', 'Low', 'Uncategorized'],
            type: 'pie',
            marker: {
                colors: ['var(--danger)', 'var(--warning)', 'var(--primary)', 'var(--success)', '#333'],
                line: {
                    color: document.body.classList.contains('dark-mode') ? 'var(--neutral-800)' : 'white',
                    width: 1
                }
            },
            textinfo: 'label+percent',
            textposition: 'outside',
            hole: 0.4,
            insidetextorientation: 'horizontal',
            hovertemplate: '<b>%{label}</b><br>Alerts: %{value}<br>Percentage: %{percent}<extra></extra>',
            textfont: {
                size: 12,
                color: '#e0e0e0',
                family: 'Inter, -apple-system, BlinkMacSystemFont, system-ui, sans-serif'
            },
            outsidetextfont: {
                size: 11,
                color: '#e0e0e0',
                family: 'Inter, -apple-system, BlinkMacSystemFont, system-ui, sans-serif'
            },
            hoverlabel: {
                bgcolor: 'rgba(30,30,30,0.95)',
                bordercolor: '#333',
                font: {
                    size: 12,
                    color: '#fff',
                    family: 'Inter, -apple-system, BlinkMacSystemFont, system-ui, sans-serif'
                }
            },
            pull: [0.05, 0.03, 0, 0, 0]
        };

        // Category chart data
        const categoryLabels = [
            {% for category, count in stats.by_category.items() %}
                "{{ category }}",
            {% endfor %}
        ];
        
        const categoryValues = [
            {% for category, count in stats.by_category.items() %}
                {{ count }},
            {% endfor %}
        ];
        
        const categoryDisplayLabels = categoryLabels.map(label => {
            // Capitalize and format the category names for better display
            return label.charAt(0).toUpperCase() + label.slice(1).replace('_', ' ');
        });

        // Color palette for categories
        const categoryColors = [
            '#007aff',  // blue
            '#ff9f0a',  // orange
            '#ff453a',  // red
            '#64d3ff',  // light blue
            '#5e5ce6',  // indigo
            '#30d158',  // green
            '#bf5af2'   // purple
        ];
        
        const categoryData = {
            x: categoryLabels,
            y: categoryValues,
            type: 'bar',
            text: categoryValues,
            textposition: 'auto',
            textfont: {
                color: '#e0e0e0',
                size: 11,
                family: 'Inter, -apple-system, BlinkMacSystemFont, system-ui, sans-serif'
            },
            marker: {
                color: categoryColors,
                opacity: 0.9,
                line: {
                    width: 1,
                    color: '#1e1e1e'
                }
            },
            hovertemplate: '<b>%{x}</b><br>Alerts: %{y}<extra></extra>',
            hoverlabel: {
                bgcolor: 'rgba(30,30,30,0.95)',
                bordercolor: '#333',
                font: {
                    size: 12,
                    color: '#fff',
                    family: 'Inter, -apple-system, BlinkMacSystemFont, system-ui, sans-serif'
                }
            }
        };

        // Historical data for category chart (mock data for now)
        const historicalData = {
            day: {
                dates: ['Yesterday', '2 Days Ago', '3 Days Ago', '4 Days Ago', '5 Days Ago', '6 Days Ago', 'Today'],
                optimizer: [9, 10, 10, 11, 11, 10, 11],
                security: [6, 6, 7, 7, 6, 6, 6],
                limits: [4, 4, 4, 4, 3, 4, 4],
                event: [3, 3, 3, 3, 3, 3, 3],
                stability: [3, 3, 3, 3, 3, 3, 3],
                portal: [3, 3, 3, 3, 3, 3, 3],
                exceptions: [2, 3, 3, 3, 3, 3, 3]
            },
            week: {
                dates: ['Week 4', 'Week 3', 'Week 2', 'Last Week', 'Current Week'],
                optimizer: [8, 9, 10, 11, 11],
                security: [5, 5, 6, 6, 6],
                limits: [2, 3, 3, 4, 4],
                event: [2, 2, 3, 3, 3],
                stability: [1, 2, 3, 3, 3],
                portal: [2, 2, 2, 3, 3],
                exceptions: [1, 2, 2, 3, 3]
            },
            month: {
                dates: ['May', 'June', 'July', 'August'],
                optimizer: [5, 7, 9, 11],
                security: [3, 4, 5, 6],
                limits: [1, 2, 3, 4],
                event: [1, 2, 2, 3],
                stability: [1, 2, 2, 3],
                portal: [1, 2, 2, 3],
                exceptions: [1, 1, 2, 3]
            },
            quarter: {
                dates: ['Q1', 'Q2', 'Q3', 'Current'],
                optimizer: [3, 6, 9, 11],
                security: [2, 3, 4, 6],
                limits: [1, 2, 3, 4],
                event: [1, 1, 2, 3],
                stability: [1, 1, 2, 3],
                portal: [0, 1, 2, 3],
                exceptions: [0, 1, 2, 3]
            }
        };
        
        // Function to toggle priority chart type between pie and bar
        function togglePriorityChartType() {
            const container = document.getElementById('priority-chart');
            
            if (priorityChartType === 'pie') {
                // Switch to bar chart
                priorityChartType = 'bar';
                priorityChartToggle.innerHTML = '<i class="bi bi-pie-chart"></i>';
                
                const barData = [{
                    x: ['Critical', 'High', 'Medium', 'Low', 'Uncategorized'],
                    y: priorityValues,
                    type: 'bar',
                    marker: {
                        color: ['#ff453a', '#ff9f0a', '#007aff', '#30d158', '#333'],
                    },
                    text: priorityValues,
                    textposition: 'auto',
                }];
                
                Plotly.react(container, barData, {
                    ...darkLayout,
                    title: '',
                    height: 320,
                    margin: { t: 10, b: 60, l: 60, r: 30 },
                });
            } else {
                // Switch back to pie chart
                priorityChartType = 'pie';
                priorityChartToggle.innerHTML = '<i class="bi bi-bar-chart"></i>';
                
                Plotly.react(container, [priorityData], priorityLayout, config);
            }
        }
        
        // Function to toggle historical view for category chart
        function toggleCategoryHistory() {
            const container = document.getElementById('category-chart');
            showCategoryHistory = !showCategoryHistory;
            
            if (showCategoryHistory) {
                // Switch to historical line chart
                categoryHistoryToggle.innerHTML = '<i class="bi bi-bar-chart"></i>';
                
                const range = historicalData[selectedTimeRange];
                const traces = categoryLabels.map((category, index) => ({
                    x: range.dates,
                    y: range[category.toLowerCase()] || Array(range.dates.length).fill(0),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: categoryDisplayLabels[index],
                    line: {
                        color: categoryColors[index % categoryColors.length],
                        width: 2
                    },
                    marker: {
                        size: 6,
                        color: categoryColors[index % categoryColors.length],
                    }
                }));
                
                const layout = {
                    ...darkLayout,
                    height: 320,
                    margin: { t: 10, b: 60, l: 60, r: 30 },
                    xaxis: {
                        title: '',
                        gridcolor: '#333',
                    },
                    yaxis: {
                        title: 'Number of Alerts',
                        gridcolor: '#333',
                    },
                    legend: {
                        orientation: 'h',
                        y: -0.2,
                        x: 0.5,
                        xanchor: 'center',
                    },
                    annotations: [{
                        x: 1,
                        y: 1.05,
                        xref: 'paper',
                        yref: 'paper',
                        text: 'Historical Data View',
                        showarrow: false,
                        font: { size: 9, color: '#aaa' },
                        align: 'right'
                    }]
                };
                
                Plotly.react(container, traces, layout, config);
            } else {
                // Switch back to bar chart
                categoryHistoryToggle.innerHTML = '<i class="bi bi-clock-history"></i>';
                Plotly.react(container, [categoryData], categoryLayout, config);
            }
        }
        
        // Function to handle time range changes
        function handleTimeRangeChange() {
            selectedTimeRange = timeRangeSelector.value;
            
            // If we're in historical view, update the chart
            if (showCategoryHistory) {
                toggleCategoryHistory(); // Turn it off
                toggleCategoryHistory(); // Turn it back on with new range
            }
            
            // Update dashboard metrics for the selected time range (would connect to backend API)
            const loadingToast = showToast('Updating dashboard data...', 'info');
            
            // Simulate API call delay
            setTimeout(() => {
                hideToast(loadingToast);
                showToast('Dashboard updated for ' + getTimeRangeLabel(), 'success');
            }, 800);
        }
        
        function getTimeRangeLabel() {
            switch(selectedTimeRange) {
                case 'day': return 'last 24 hours';
                case 'week': return 'last 7 days';
                case 'month': return 'last 30 days';
                case 'quarter': return 'last 90 days';
                default: return 'selected period';
            }
        }
        
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'primary'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi bi-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            toastContainer.innerHTML += toastHtml;
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 3000 });
            toast.show();
            return toastId;
        }
        
        function hideToast(toastId) {
            const toastElement = document.getElementById(toastId);
            if (toastElement) {
                const toast = bootstrap.Toast.getInstance(toastElement);
                if (toast) toast.hide();
            }
        }
        
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(container);
            return container;
        }
        
        // Refresh data button handler
        if (refreshDataBtn) {
            refreshDataBtn.addEventListener('click', function() {
                const loadingToast = showToast('Refreshing dashboard data...', 'info');
                
                // Add spinner to button
                const originalHTML = refreshDataBtn.innerHTML;
                refreshDataBtn.disabled = true;
                refreshDataBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Refreshing...';
                
                // Simulate API call delay
                setTimeout(() => {
                    refreshDataBtn.disabled = false;
                    refreshDataBtn.innerHTML = originalHTML;
                    hideToast(loadingToast);
                    showToast('Dashboard data refreshed successfully', 'success');
                }, 1000);
            });
        }
        
        // Initialize event listeners for chart controls
        if (priorityChartToggle) {
            priorityChartToggle.addEventListener('click', togglePriorityChartType);
        }
        
        if (categoryHistoryToggle) {
            categoryHistoryToggle.addEventListener('click', toggleCategoryHistory);
        }
        
        if (timeRangeSelector) {
            timeRangeSelector.addEventListener('change', handleTimeRangeChange);
        }
        
        // Create the charts with enhanced settings
        const priorityLayout = {
            ...darkLayout,
            legend: {
                orientation: 'h',
                y: -0.2,
                x: 0.5,
                xanchor: 'center',
                font: {
                    size: 11,
                    color: '#aaa',
                    family: 'Inter, -apple-system, BlinkMacSystemFont, system-ui, sans-serif'
                },
                bgcolor: 'rgba(0,0,0,0)',
                bordercolor: 'rgba(0,0,0,0)'
            },
            annotations: [
                {
                    font: {
                        size: 16,
                        color: '#e0e0e0',
                        family: 'Inter, -apple-system, BlinkMacSystemFont, system-ui, sans-serif'
                    },
                    showarrow: false,
                    text: 'Priority',
                    x: 0.5,
                    y: 0.5
                },
                {
                    x: 1,
                    y: 1.05,
                    xref: 'paper',
                    yref: 'paper',
                    text: 'Last updated: Today',
                    showarrow: false,
                    font: {
                        size: 9,
                        color: '#aaa'
                    },
                    align: 'right'
                }
            ]
        };
        
        const categoryLayout = {
            ...darkLayout,
            xaxis: {
                tickangle: -45,
                tickfont: {
                    size: 10,
                    family: 'Inter, -apple-system, BlinkMacSystemFont, system-ui, sans-serif'
                },
                tickmode: 'array',
                tickvals: categoryLabels,
                ticktext: categoryDisplayLabels,
                gridcolor: '#333',
                gridwidth: 0.5,
                zerolinecolor: '#444',
                zerolinewidth: 1
            },
            yaxis: {
                title: {
                    text: 'Number of Alerts',
                    font: {
                        size: 12,
                        color: '#aaa',
                        family: 'Inter, -apple-system, BlinkMacSystemFont, system-ui, sans-serif'
                    },
                    standoff: 10
                },
                gridcolor: 'rgba(51, 51, 51, 0.7)',
                gridwidth: 0.5,
                zerolinecolor: '#444',
                zerolinewidth: 1,
                fixedrange: false,
                automargin: true
            },
            bargap: 0.3,
            shapes: [{
                type: 'line',
                x0: -0.5,
                y0: 0,
                x1: categoryLabels.length - 0.5,
                y1: 0,
                line: {
                    color: '#444',
                    width: 1
                }
            }],
            annotations: [{
                x: 1,
                y: 1.05,
                xref: 'paper',
                yref: 'paper',
                text: 'Source: Salesforce Health Check',
                showarrow: false,
                font: {
                    size: 9,
                    color: '#aaa'
                },
                align: 'right'
            }]
        };

        const config = {
            responsive: true,
            displayModeBar: 'hover',
            modeBarButtonsToRemove: ['select2d', 'lasso2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'toggleSpikelines', 'hoverClosestCartesian', 'hoverCompareCartesian'],
            toImageButtonOptions: {
                format: 'png',
                filename: 'salesforce-health-check',
                height: 500,
                width: 700,
                scale: 2
            }
        };

        Plotly.newPlot('priority-chart', [priorityData], priorityLayout, config);
        Plotly.newPlot('category-chart', [categoryData], categoryLayout, config);
    });
</script>
{% endblock %}