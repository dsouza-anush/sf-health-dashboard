{% extends "base.html" %}

{% block title %}Create New Health Alert - Salesforce Health Check{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/" class="text-primary">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="/alerts" class="text-primary">Alerts</a></li>
                <li class="breadcrumb-item active" aria-current="page">Create New Alert</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-semibold">Create New Health Alert</h5>
            </div>
            <div class="card-body">
                <form id="create-alert-form">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="4" required></textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="" selected disabled>Select a category</option>
                                <option value="optimizer">Optimizer</option>
                                <option value="security">Security</option>
                                <option value="limits">Limits</option>
                                <option value="event">Event</option>
                                <option value="stability">Stability</option>
                                <option value="portal">Portal</option>
                                <option value="exceptions">Exceptions</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="source_system" class="form-label">Source System</label>
                            <select class="form-select" id="source_system" name="source_system" required>
                                <option value="" selected disabled>Select source system</option>
                                <option value="Salesforce Optimizer">Salesforce Optimizer</option>
                                <option value="Salesforce Security Health">Salesforce Security Health</option>
                                <option value="Salesforce Limits Health">Salesforce Limits Health</option>
                                <option value="Splunk Event Health">Splunk Event Health</option>
                                <option value="ServiceNow">ServiceNow</option>
                                <option value="Salesforce Portal Health">Salesforce Portal Health</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="raw_data" class="form-label">Raw Data (Optional)</label>
                        <textarea class="form-control" id="raw_data" name="raw_data" rows="3"></textarea>
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline me-md-2" onclick="window.location.href='/alerts'">Cancel</button>
                        <button type="submit" id="create-btn" class="btn btn-primary">Create & Categorize</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card mb-4 shadow-sm">
            <div class="card-header">
                <h5 class="mb-0 fw-semibold">AI Categorization Demo</h5>
            </div>
            <div class="card-body">
                <p>Click "Create & Categorize" to have the AI analyze your alert and provide:</p>
                <ul>
                    <li>The most appropriate category</li>
                    <li>Priority level based on impact</li>
                    <li>Concise summary of the issue</li>
                    <li>Recommended actions</li>
                </ul>
                <div class="alert alert-info" role="alert">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle me-2" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                    </svg>
                    The Heroku AI agent analyzes and categorizes health alerts in real-time for improved incident response.
                </div>
            </div>
        </div>

        <!-- AI Analysis Results (initially hidden) -->
        <div id="analysis-result" class="card d-none shadow">
            <div class="analysis-header">
                <h5 class="mb-0 fw-semibold">AI Analysis Results</h5>
            </div>
            <div class="card-body">
                <div id="analysis-loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Analyzing with Heroku AI...</p>
                </div>
                <div id="analysis-content" class="d-none">
                    <div class="mb-3 d-flex flex-wrap gap-2">
                        <div class="me-3">
                            <strong>Category:</strong>
                            <span id="ai-category" class="badge bg-info ms-1 fs-6"></span>
                        </div>
                        <div>
                            <strong>Priority:</strong>
                            <span id="ai-priority" class="badge ms-1 fs-6"></span>
                        </div>
                    </div>
                    
                    <div class="mb-3 analysis-result-section">
                        <h6 class="border-bottom pb-2 text-primary fw-semibold">Summary</h6>
                        <p id="ai-summary" class="mt-2 analysis-result-content"></p>
                    </div>
                    
                    <div class="analysis-result-section">
                        <h6 class="border-bottom pb-2 text-primary fw-semibold">Recommendation</h6>
                        <p id="ai-recommendation" class="mt-2 analysis-result-content"></p>
                    </div>
                </div>
                <div id="analysis-error" class="d-none">
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <span id="error-message">Failed to analyze alert. Please try again.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('create-alert-form');
        const createBtn = document.getElementById('create-btn');
        const analysisResult = document.getElementById('analysis-result');
        const analysisLoading = document.getElementById('analysis-loading');
        const analysisContent = document.getElementById('analysis-content');
        const analysisError = document.getElementById('analysis-error');
        
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading state
            createBtn.disabled = true;
            createBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
            
            // Show the analysis result card with loading state
            analysisResult.classList.remove('d-none');
            analysisLoading.classList.remove('d-none');
            analysisContent.classList.add('d-none');
            analysisError.classList.add('d-none');
            
            // Collect form data
            const formData = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                category: document.getElementById('category').value,
                source_system: document.getElementById('source_system').value,
                raw_data: document.getElementById('raw_data').value || null
            };
            
            try {
                // Create and categorize the alert
                const response = await fetch('/api/alerts/create-and-categorize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.detail || 'Failed to create alert');
                }
                
                // Update UI with the result
                document.getElementById('ai-category').textContent = result.ai_category || 'Not categorized';
                
                // Set priority badge color based on priority level
                const priorityBadge = document.getElementById('ai-priority');
                priorityBadge.textContent = result.ai_priority || 'Unknown';
                if (result.ai_priority) {
                    if (result.ai_priority === 'critical') {
                        priorityBadge.className = 'badge bg-danger';
                    } else if (result.ai_priority === 'high') {
                        priorityBadge.className = 'badge bg-warning';
                    } else if (result.ai_priority === 'medium') {
                        priorityBadge.className = 'badge bg-primary';
                    } else if (result.ai_priority === 'low') {
                        priorityBadge.className = 'badge bg-success';
                    }
                }
                
                document.getElementById('ai-summary').textContent = result.ai_summary || 'No summary available';
                document.getElementById('ai-recommendation').textContent = result.ai_recommendation || 'No recommendations available';
                
                // Hide loading, show content
                analysisLoading.classList.add('d-none');
                analysisContent.classList.remove('d-none');
                
                // Reset button state
                createBtn.disabled = false;
                createBtn.textContent = 'Create & Categorize';
                
                // Optional: Scroll to results
                analysisResult.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                // Show error message
                analysisLoading.classList.add('d-none');
                analysisError.classList.remove('d-none');
                document.getElementById('error-message').textContent = error.message || 'Failed to analyze alert. Please try again.';
                
                // Reset button state
                createBtn.disabled = false;
                createBtn.textContent = 'Create & Categorize';
                
                console.error('Error:', error);
            }
        });
    });
</script>
{% endblock %}